<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Products/Vault/technical">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">ERC-4626 | Dynamo</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://dynamofinance.github.io/docs/Products/Vault/technical"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="ERC-4626 | Dynamo"><meta data-rh="true" name="description" content="Red letters are contract addresses."><meta data-rh="true" property="og:description" content="Red letters are contract addresses."><link data-rh="true" rel="icon" href="/favicon.ico"><link data-rh="true" rel="canonical" href="https://dynamofinance.github.io/docs/Products/Vault/technical"><link data-rh="true" rel="alternate" href="https://dynamofinance.github.io/docs/Products/Vault/technical" hreflang="en"><link data-rh="true" rel="alternate" href="https://dynamofinance.github.io/docs/Products/Vault/technical" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://YHEMCW7E5Q-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Dynamo RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Dynamo Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Dynamo" href="/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.77e094f3.css">
<link rel="preload" href="/assets/js/runtime~main.0dcb9e80.js" as="script">
<link rel="preload" href="/assets/js/main.633c3b63.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="DynamoFinance" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="DynamoFinance" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"> </b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Documentation</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/DynamoFinance" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.svg" alt="DynamoFinance" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="DynamoFinance" class="themedImage_ToTc themedImage--dark_i4oU"><b> </b></a><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Getting started</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/links">Links</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/security">Security audits</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/Products/Vault">Products</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/Products/Vault">Vault</a><button aria-label="Toggle the collapsible sidebar category &#x27;Vault&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Products/Vault/white-paper">Whitepaper</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Products/Vault/technical">ERC-4626</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Products/Vault/governance">Governance</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Products/Vault/Primers/legacy_stable_pools">Primers</a></div></li></ul></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Products</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/Products/Vault"><span itemprop="name">Vault</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">ERC-4626</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Smart-contract architecture</h1><p>Red letters are contract addresses.
Bold black items are actual ERC20/Pool assets. Blue zone is Vyper contract code.
The dotted line LPAdapters are logical contracts but likely will just be code in the larger AssetManager contract code base which forward requests to deployments of Lending Platform Specific Adapters.
Green zones are Balancer Linear Pools which will require small amounts of Solidity code to construct properly.
Yellow zone is the Balancer Boosted Pool which will require some Solidity code to fully implement/integrate.
At the bottom outside the yellow zone are the various Lending Platforms.</p><p><img loading="lazy" alt="dUSD" src="/assets/images/dUSDdiagram-1b050bedac7b252f672624807e844940.png" width="1007" height="771" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="use-cases-for-dynamo4626-contracts">Use Cases for Dynamo4626 Contracts<a class="hash-link" href="#use-cases-for-dynamo4626-contracts" title="Direct link to heading">​</a></h3><p>The Dynamo4626 Contracts will act as AssetManagers for the Balancer LinearPools but can be treated as their own Vaults/Pools outside of the deployed Balancer Vault.</p><p><em>Given:</em></p><p>Governance = address variable - Governance contract responsible for this Vault.</p><p>Being ERC-4626 Contracts, they expose the full <a href="https://eips.ethereum.org/EIPS/eip-20" target="_blank" rel="noopener noreferrer">ERC-20 ABI</a>.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="dynamo4626-transactional-use-cases">Dynamo4626 Transactional Use Cases<a class="hash-link" href="#dynamo4626-transactional-use-cases" title="Direct link to heading">​</a></h3><p>Definitions:</p><p>asset - underlying token by which value transactions are ultimately denominated.
For DynamoUSD this would be one of DAI, FRAX, or GHO initially.</p><p>shares - the 4626 token representing the investment of liquidity to ultimately be converted back into assets.
For DynamoUSD this would be dDAI, dFRAX, dGHO, and dUSD.</p><p>destination - the address of the contract or wallet to receive the value of the transaction.</p><p>owner - the address of the contract that holds the assets in question.</p><p>Transfer - struct for transaction definition containing a signed qty and Adapter addr.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="deposit-assets-destination---shares">deposit (assets, destination) -&gt; shares<a class="hash-link" href="#deposit-assets-destination---shares" title="Direct link to heading">​</a></h4><p>Deposit fixed number of X assets for destination to receive Y shares representing the new investment.
Shares will be credited to destination address.</p><div class="mermaid" data-mermaid-src="sequenceDiagram
    participant u as Investor
    participant a4626 as d&lt;Token&gt;4626    
    participant lpa as LP Adapter
    participant asset as &lt;ERC20 Asset Token&gt;&lt;br&gt;&quot;asset&quot;
    #participant lp as LP
    #participant share as &lt;ERC20 LP Share&gt;
    participant eth as Ethereum Mainnet
    note over a4626: a4626 = d&lt;Token&gt;4626 contract address
    autonumber
    u-&gt;&gt;a4626:deposit(_asset_amount = 500, _receiver = Investor)
        note over a4626, asset: We must first move the funds into the contract&#x27;s balance so _getBalanceTxs will know how to best re-adjust.    
        a4626--&gt;&gt;a4626: Shares = _convertToShares(_asset_amount)
        a4626-&gt;&gt;asset: transferFrom(from=Investor, to=a4626, amt=500)
        Note over asset: balanceOf[Investor]-=500&lt;br&gt;balanceOf[d&lt;Token&gt;4626]+=500
        asset-&gt;&gt;a4626: amt=500
        a4626--&gt;&gt;a4626: balanceAdapters(_target_asset_balance=0)
        Note over a4626: See balanceAdapters use case diagram below.
        Note over a4626: Compute most efficient rebalancing transactions.&lt;br&gt;Txs = _genBalanceTxs()
        a4626--&gt;&gt;a4626: _genBalanceTxs() -&gt; Transfer[]
        loop for Tx: Transfer in Txs&lt;br&gt;(limited to maxTxs iterations)
            alt if Tx.Qty==0
                note over a4626: break
            else if Tx.Qty &gt; 0
                a4626-&gt;&gt;lpa: (Tx.Adapter).deposit(Tx.Qty)
                    note over lpa: asset.balanceOf[d&lt;Token&gt;4626]-=Tx.Qty&lt;br&gt;asset.balanceOf[LP]+=Tx.Qty&lt;br&gt;share.balanceOf[d&lt;Token&gt;4626]+=~Tx.Qty          
            else (elif Tx.Qty &lt; 0)
                a4626-&gt;&gt;lpa: (Tx.Adapter).withdraw(&lt;br&gt;asset_amount=-1 * Tx.Qty,&lt;br&gt;withdraw_to=d&lt;Token&gt;4626)
                    note over lpa: asset.balanceOf[LP]-=~Tx.Qty&lt;br&gt;share.balanceOf[d&lt;Token&gt;4626]-=~Tx.Qty&lt;br&gt;asset.balanceOf[d&lt;Token&gt;4626]+=Tx.Qty
            end
        end
        a4626-&gt;a4626: Assets = _mint(dest=Investor, amt=Shares)
            note over a4626:d&lt;Token&gt;4626.balanceOf[Investor]+=Shares
        a4626-&gt;u: return Shares">sequenceDiagram
    participant u as Investor
    participant a4626 as d&lt;Token&gt;4626    
    participant lpa as LP Adapter
    participant asset as &lt;ERC20 Asset Token&gt;&lt;br&gt;&quot;asset&quot;
    #participant lp as LP
    #participant share as &lt;ERC20 LP Share&gt;
    participant eth as Ethereum Mainnet
    note over a4626: a4626 = d&lt;Token&gt;4626 contract address
    autonumber
    u-&gt;&gt;a4626:deposit(_asset_amount = 500, _receiver = Investor)
        note over a4626, asset: We must first move the funds into the contract&#x27;s balance so _getBalanceTxs will know how to best re-adjust.    
        a4626--&gt;&gt;a4626: Shares = _convertToShares(_asset_amount)
        a4626-&gt;&gt;asset: transferFrom(from=Investor, to=a4626, amt=500)
        Note over asset: balanceOf[Investor]-=500&lt;br&gt;balanceOf[d&lt;Token&gt;4626]+=500
        asset-&gt;&gt;a4626: amt=500
        a4626--&gt;&gt;a4626: balanceAdapters(_target_asset_balance=0)
        Note over a4626: See balanceAdapters use case diagram below.
        Note over a4626: Compute most efficient rebalancing transactions.&lt;br&gt;Txs = _genBalanceTxs()
        a4626--&gt;&gt;a4626: _genBalanceTxs() -&gt; Transfer[]
        loop for Tx: Transfer in Txs&lt;br&gt;(limited to maxTxs iterations)
            alt if Tx.Qty==0
                note over a4626: break
            else if Tx.Qty &gt; 0
                a4626-&gt;&gt;lpa: (Tx.Adapter).deposit(Tx.Qty)
                    note over lpa: asset.balanceOf[d&lt;Token&gt;4626]-=Tx.Qty&lt;br&gt;asset.balanceOf[LP]+=Tx.Qty&lt;br&gt;share.balanceOf[d&lt;Token&gt;4626]+=~Tx.Qty          
            else (elif Tx.Qty &lt; 0)
                a4626-&gt;&gt;lpa: (Tx.Adapter).withdraw(&lt;br&gt;asset_amount=-1 * Tx.Qty,&lt;br&gt;withdraw_to=d&lt;Token&gt;4626)
                    note over lpa: asset.balanceOf[LP]-=~Tx.Qty&lt;br&gt;share.balanceOf[d&lt;Token&gt;4626]-=~Tx.Qty&lt;br&gt;asset.balanceOf[d&lt;Token&gt;4626]+=Tx.Qty
            end
        end
        a4626-&gt;a4626: Assets = _mint(dest=Investor, amt=Shares)
            note over a4626:d&lt;Token&gt;4626.balanceOf[Investor]+=Shares
        a4626-&gt;u: return Shares</div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="mint-shares-destination---assets">mint (shares, destination) -&gt; assets<a class="hash-link" href="#mint-shares-destination---assets" title="Direct link to heading">​</a></h4><p>Deposit X assets where X is determined to be the quantity required to receive Y shares representing the new investment.<br>
<!-- -->Shares will be credited to destination address. For DynamoUSD this would be the LinearPool which this
contract is an AssetManager for.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="withdraw-assets-destination-owner---shares">withdraw (assets, destination, owner) -&gt; shares<a class="hash-link" href="#withdraw-assets-destination-owner---shares" title="Direct link to heading">​</a></h4><p>Convert X shares controlled by owner back to Y assets to be credited to destination.</p><div class="mermaid" data-mermaid-src="sequenceDiagram
participant u as Investor
participant a4626 as d&lt;Token&gt;4626
participant lpa as LP Adapter
participant asset as &lt;ERC20 Asset Token&gt;&lt;br&gt;&quot;asset&quot;
#participant lp as LP
#participant share as &lt;ERC20 LP Share&gt;
participant eth as Ethereum Mainnet
    autonumber
    u-&gt;&gt;a4626:withdraw(asset_amount = 500, receiver = Investor, owner = Investor)
    Note over a4626: Map asset_amount to share value&lt;br&gt;&amp; get owner&#x27;s share balance.
    a4626--&gt;&gt;a4626: shares = _convertToShares(asset_amount)
    a4626--&gt;&gt;a4626: xcbal = self.balanceOf[owner]
    Note over a4626: Is the owner not the receiver?
    alt if msg.sender != owner
        Note over a4626: Confirm msg.sender has adequate allowance from owner.
        Note over a4626: Reduce msg.senders allowance from owner.
    end
    Note over a4626: Reduce owner balance of shares.&lt;br&gt;Reduce total supply of shares.
    a4626-&gt;&gt;eth: log Transfer(owner, 0, shares) (Burn shares)
    a4626--&gt;&gt;a4626: balanceAdapters(_target_asset_balance = asset_amount)
    Note over a4626: See balanceAdapters use case diagram below.
    Note over a4626: Move asset tokens to receiver.
    a4626-&gt;&gt;asset: transfer(Investor, asset_amount)
    Note over a4626: Update Vault&#x27;s total_assets_withdrawn by asset_amount.
    a4626-&gt;&gt;eth: log Withdraw(msg.sender, Investor, owner, asset_amount, shares)
    a4626-&gt;&gt;u: return shares">sequenceDiagram
participant u as Investor
participant a4626 as d&lt;Token&gt;4626
participant lpa as LP Adapter
participant asset as &lt;ERC20 Asset Token&gt;&lt;br&gt;&quot;asset&quot;
#participant lp as LP
#participant share as &lt;ERC20 LP Share&gt;
participant eth as Ethereum Mainnet
    autonumber
    u-&gt;&gt;a4626:withdraw(asset_amount = 500, receiver = Investor, owner = Investor)
    Note over a4626: Map asset_amount to share value&lt;br&gt;&amp; get owner&#x27;s share balance.
    a4626--&gt;&gt;a4626: shares = _convertToShares(asset_amount)
    a4626--&gt;&gt;a4626: xcbal = self.balanceOf[owner]
    Note over a4626: Is the owner not the receiver?
    alt if msg.sender != owner
        Note over a4626: Confirm msg.sender has adequate allowance from owner.
        Note over a4626: Reduce msg.senders allowance from owner.
    end
    Note over a4626: Reduce owner balance of shares.&lt;br&gt;Reduce total supply of shares.
    a4626-&gt;&gt;eth: log Transfer(owner, 0, shares) (Burn shares)
    a4626--&gt;&gt;a4626: balanceAdapters(_target_asset_balance = asset_amount)
    Note over a4626: See balanceAdapters use case diagram below.
    Note over a4626: Move asset tokens to receiver.
    a4626-&gt;&gt;asset: transfer(Investor, asset_amount)
    Note over a4626: Update Vault&#x27;s total_assets_withdrawn by asset_amount.
    a4626-&gt;&gt;eth: log Withdraw(msg.sender, Investor, owner, asset_amount, shares)
    a4626-&gt;&gt;u: return shares</div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="withdraw-assets-destination-owner---shares-1">withdraw (assets, destination, owner) -&gt; shares<a class="hash-link" href="#withdraw-assets-destination-owner---shares-1" title="Direct link to heading">​</a></h4><p>Convert X shares controlled by owner where X is determined to be the quantity required to receive Y assets
(to be credited to destination) resulting from the share value of the investment.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="dynamo4626-supporting-functions">Dynamo4626 Supporting Functions<a class="hash-link" href="#dynamo4626-supporting-functions" title="Direct link to heading">​</a></h3><p>There may be matching preview<em> and max</em> functions for each of the deposit/mint/redeem/withdraw functions.
These simply provide read-only outcome &#x27;previews&#x27; or maximum values possible given current balances respectively.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="dynamo4626-configurationdeployment-use-cases">Dynamo4626 Configuration/Deployment Use Cases<a class="hash-link" href="#dynamo4626-configurationdeployment-use-cases" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="activatestrategy">activateStrategy()<a class="hash-link" href="#activatestrategy" title="Direct link to heading">​</a></h4><p>Checks to see if the Governance contract has a new strategy ready to activate.
If so, makes it the new current strategy then calls rebalance to put it into effect.
This function may be called by anyone.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="balanceadapterstarget_asset_balance--0">balanceAdapters(target_asset_balance = 0)<a class="hash-link" href="#balanceadapterstarget_asset_balance--0" title="Direct link to heading">​</a></h4><p>Compares the current cash &amp; asset values across the lending platforms, computes an
optimum set of transactions necessary to best meet the current Strategy&#x27;s desired
balances, then proceeds to move assets across the lending platforms to best meet the
current strategy. If target_asset_balance == 0 then it is a request to move all asset into
various adapters. If target_asset_balance &gt; 0 then it is a request to move this sum of
assets into the 4626 vault so it can be available for a withdrawl and move the rest of the
assets to adapters according to the current Strategy.</p><p>This function may be called by anyone.</p><p>balanceAdapters Use Case</p><div class="mermaid" data-mermaid-src="sequenceDiagram 
    participant user as Calling Wallet
    participant a4626 as d&lt;Token&gt;4626
    participant fund as FundsAllocator
    #participant lpa as LP Adapter
    participant eth as Ethereum Mainnet
    autonumber
    user-&gt;&gt;a4626: balanceAdapters(_target_asset_balance=0)
    Note over a4626:Call _getCurrentBalances to copy state of the 4626 because all functions&lt;br&gt;in FundsAllocator are stateless so must be passed these values.&lt;br&gt;_total_assets = current assets in vault&lt;br&gt;_total_ratios = sum of strategy ratios in vault&lt;br&gt;_pool_states = [each pool struct = {adapter, current assets in pool, ratio for this adapter},...]
    a4626-&gt;&gt;fund: getBalanceTxs(_target_asset_balance,&lt;br&gt;_min_proposer_payout,&lt;br&gt;_total_assets,&lt;br&gt;_total_ratios,&lt;br&gt;_pool_states)
    Note over fund:The functions in the FundsAllocator are upgradable but have&lt;br&gt;no access to Vault data beyond what is passed to it.&lt;br&gt;It&#x27;s purpose is to create a list of transactions that&lt;br&gt;will optimally result in final balances of assets&lt;br&gt;in the 4626 Vault + move funds across the adapters to&lt;br&gt;achieve tarets established by the current strategy.
    fund-&gt;&gt;a4626: txs = TXS, blocked_adapters = [Blocked_Adapters]
    Note over a4626: If there are blocked adapters then&lt;br&gt;set their strategy ratios to zero.
    loop for Adapter: adapter in blocked_adapters
        alt if Adapter != 0
            Note over a4626: Funds missing from this Adapter!&lt;br&gt;Revise strategy ratio and publish PoolLoss event!
            Note over a4626: new_strat = self.strategy[Adapter]&lt;br&gt;new_strat.ratio = 0&lt;br&gt;self.strategy[Adapter] = new_strat
            a4626-&gt;&gt;eth: log PoolLoss(Adapter, new_strat.last_asset_value, self._poolAssets(Adapter))
        end
    end
    Note over a4626: Now actually move the funds for qualified txs.
    loop for Dtx: dtx in txs
        alt if Dtx.qty &gt; 0 and Dtx.qty &gt; Minimum TX Value from Strategy
            Note over a4626: Execute a deposit into the adapter&lt;br&gt;large enough to be worth the gas&lt;br&gt;from the 4626 Vault.
        else if Dtx.qrt &lt; 0:
            Note over a4626: Execute a withdraw from the adapter into the 4626 Vault.
        end
    end">sequenceDiagram 
    participant user as Calling Wallet
    participant a4626 as d&lt;Token&gt;4626
    participant fund as FundsAllocator
    #participant lpa as LP Adapter
    participant eth as Ethereum Mainnet
    autonumber
    user-&gt;&gt;a4626: balanceAdapters(_target_asset_balance=0)
    Note over a4626:Call _getCurrentBalances to copy state of the 4626 because all functions&lt;br&gt;in FundsAllocator are stateless so must be passed these values.&lt;br&gt;_total_assets = current assets in vault&lt;br&gt;_total_ratios = sum of strategy ratios in vault&lt;br&gt;_pool_states = [each pool struct = {adapter, current assets in pool, ratio for this adapter},...]
    a4626-&gt;&gt;fund: getBalanceTxs(_target_asset_balance,&lt;br&gt;_min_proposer_payout,&lt;br&gt;_total_assets,&lt;br&gt;_total_ratios,&lt;br&gt;_pool_states)
    Note over fund:The functions in the FundsAllocator are upgradable but have&lt;br&gt;no access to Vault data beyond what is passed to it.&lt;br&gt;It&#x27;s purpose is to create a list of transactions that&lt;br&gt;will optimally result in final balances of assets&lt;br&gt;in the 4626 Vault + move funds across the adapters to&lt;br&gt;achieve tarets established by the current strategy.
    fund-&gt;&gt;a4626: txs = TXS, blocked_adapters = [Blocked_Adapters]
    Note over a4626: If there are blocked adapters then&lt;br&gt;set their strategy ratios to zero.
    loop for Adapter: adapter in blocked_adapters
        alt if Adapter != 0
            Note over a4626: Funds missing from this Adapter!&lt;br&gt;Revise strategy ratio and publish PoolLoss event!
            Note over a4626: new_strat = self.strategy[Adapter]&lt;br&gt;new_strat.ratio = 0&lt;br&gt;self.strategy[Adapter] = new_strat
            a4626-&gt;&gt;eth: log PoolLoss(Adapter, new_strat.last_asset_value, self._poolAssets(Adapter))
        end
    end
    Note over a4626: Now actually move the funds for qualified txs.
    loop for Dtx: dtx in txs
        alt if Dtx.qty &gt; 0 and Dtx.qty &gt; Minimum TX Value from Strategy
            Note over a4626: Execute a deposit into the adapter&lt;br&gt;large enough to be worth the gas&lt;br&gt;from the 4626 Vault.
        else if Dtx.qrt &lt; 0:
            Note over a4626: Execute a withdraw from the adapter into the 4626 Vault.
        end
    end</div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/DynamoFinance/dynamofinance.github.io/tree/main/docs/Products/Vault/technical.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Products/Vault/white-paper"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Whitepaper</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Products/Vault/governance"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Governance</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#use-cases-for-dynamo4626-contracts" class="table-of-contents__link toc-highlight">Use Cases for Dynamo4626 Contracts</a></li><li><a href="#dynamo4626-transactional-use-cases" class="table-of-contents__link toc-highlight">Dynamo4626 Transactional Use Cases</a></li><li><a href="#dynamo4626-supporting-functions" class="table-of-contents__link toc-highlight">Dynamo4626 Supporting Functions</a></li><li><a href="#dynamo4626-configurationdeployment-use-cases" class="table-of-contents__link toc-highlight">Dynamo4626 Configuration/Deployment Use Cases</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Get started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/Products/Vault">Vault</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://t.co/4RLMjyVNtG" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/DynamoFinance" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/DynamoFinance" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 DynamoFinance.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0dcb9e80.js"></script>
<script src="/assets/js/main.633c3b63.js"></script>
</body>
</html>